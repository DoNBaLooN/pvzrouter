# PvZ Router Hotspot

Репозиторий содержит готовый набор страниц NoDogSplash и CGI-скриптов на `ash` для организации кодовой авторизации Wi-Fi на роутерах с OpenWrt. Решение включает установочный скрипт, портал авторизации для гостей и административную панель управления.

## Требования
- Установленная прошивка OpenWrt с доступом по SSH.
- Пакеты `nodogsplash`, `uhttpd` и `busybox` (для `crond`). Скрипт установки проверяет наличие `nodogsplashctl`, `uhttpd` и `crond`, завершая работу при отсутствии зависимостей.

## Подготовка
1. Подключитесь к роутеру по SSH под пользователем `root`.
2. Убедитесь, что необходимые пакеты присутствуют. При необходимости установите их:
   ```sh
   opkg update
   opkg install nodogsplash uhttpd
   ```
   (пакет `busybox` предустановлен и содержит `crond` на типичных сборках OpenWrt).
3. Клонируйте репозиторий на рабочую машину и скопируйте каталог `pvzrouter` на роутер, например:
   ```sh
   scp -r pvzrouter root@192.168.1.1:/tmp/
   ```

## Установка на OpenWrt
1. Подключитесь по SSH и перейдите в каталог с файлами:
   ```sh
   ssh root@192.168.1.1
   cd /tmp/pvzrouter
   ```
2. Запустите установочный скрипт:
   ```sh
   sh install.sh
   ```
   Скрипт остановит и отключит автозапуск NoDogSplash, создаст директории `/etc/nodogsplash/htdocs` и `/www/cgi-bin/api`, скопирует HTML-страницы и CGI-скрипты, а также настроит файл `/etc/config/wifi_auth` с параметрами по умолчанию. Он также добавит проверку сессий в cron (`/etc/crontabs/root`) и настроит `uhttpd` на обработку CGI по адресу `/api` с интерпретатором `/bin/ash`.
3. После выполнения скрипт сообщит о завершении. NoDogSplash остается остановленным до включения через админку или команду API.

## Конфигурация `wifi_auth`
Параметры портала хранятся в `/etc/config/wifi_auth` и автоматически создаются при первом запуске. Файл содержит:
- `code` — текущий код дня (по умолчанию `0000`).
- `duration` — длительность доступа в минутах (по умолчанию `60`).
- `nds_enabled` — признак включения NoDogSplash (0/1).

Создание и чтение этих значений выполняется общей библиотекой `/www/cgi-bin/api/common.sh`, которая также управляет файлами сессий и белым списком MAC. При необходимости параметры можно изменить вручную или через административный интерфейс.

## Фоновые задачи
Скрипт `session_check.sh` периодически запускается cron-ом каждые 5 минут и удаляет просроченные сессии, параллельно взаимодействуя с `nodogsplashctl` для очистки клиентов. Файл активных сессий находится в `/tmp/active_sessions.txt`, а список постоянного доступа — в `/etc/nodogsplash/whitelist_macs`.

## Административная панель
Файл `/etc/nodogsplash/htdocs/admin.html` представляет собой SPA-панель управления, доступную через веб-интерфейс NoDogSplash (по умолчанию `http://<IP_роутера>:2050/admin.html`). Возможности панели:
- Просмотр текущих настроек и состояния NoDogSplash (`/api/admin/get`).
- Обновление кода и длительности доступа (`/api/admin/update`).
- Очистка активных сессий (`/api/admin/clear`).
- Запуск/остановка NoDogSplash (`/api/admin/nds`).
- Добавление MAC-адреса в белый список с немедленной авторизацией (`/api/admin/mac_add`).
- Получение статуса активных клиентов (`/api/admin/status`).

Все AJAX-запросы выполняются к CGI-скриптам в `/www/cgi-bin/api`, которые возвращают JSON и взаимодействуют с NoDogSplash через `nodogsplashctl` и конфигурацию `wifi_auth`. Например, авторизационный скрипт `auth.sh` проверяет введенный код, фиксирует сессию и выдает доступ на заданное время, а административные скрипты обновляют конфигурацию и управляют сервисом.

## Портал для гостей
Страницы `splash.html`, `success.html` и `denied.html` размещены в `/etc/nodogsplash/htdocs` и отображаются гостям при попытке выхода в интернет. Форма на `splash.html` отправляет введенный код на `/api/auth`, после чего пользователь либо перенаправляется на страницу успеха, либо на страницу с ошибкой.

## Дополнительные советы
- Изменяйте HTML-файлы в `/etc/nodogsplash/htdocs`, чтобы адаптировать внешний вид портала под бренд.
- Для резервного копирования достаточно сохранить `/etc/config/wifi_auth`, `/etc/nodogsplash/htdocs/` и `/www/cgi-bin/api/`.
- При обновлении системы повторно запустите `install.sh`, чтобы восстановить нужные файлы и настройки.
