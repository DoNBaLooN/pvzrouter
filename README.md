# Wi-Fi Day-Code Captive Portal

Проект для OpenWrt 24.10.0, реализующий офлайн-портал авторизации с ежедневным кодом доступа. Решение работает поверх NoDogSplash и хранит всю информацию локально.

## Возможности

### Для посетителей
- Перенаправление на `/index.html` с формой ввода «кода дня».
- Проверка введённого кода через CGI-скрипт `/cgi-bin/wifi_auth.sh`.
- При успешной проверке MAC-адрес заносится в whitelist NoDogSplash и устройство получает доступ на заданный интервал времени.
- Показывается страница `/success.html` и создаётся запись с моментом окончания сессии в `/tmp/active_sessions.txt`.
- По истечении времени сессия автоматически закрывается.

### Для администратора
- Веб-панель `/admin.html` (требуется доступ из LAN) отображает текущий код, длительность, дату последнего обновления и число активных клиентов.
- В панели можно:
  - изменить код и длительность через форму (обработчик `/cgi-bin/update_code.sh`);
  - вручную очистить все активные сессии (`/cgi-bin/clear_sessions.sh`);
  - перезапустить NoDogSplash (`/cgi-bin/restart_portal.sh`).
- Планировщик (`session_check.sh`) каждые 5 минут удаляет просроченные сессии и отзывает доступ у клиентов.

## Структура
```
/www/
 ├─ index.html            # страница для посетителей
 ├─ success.html          # сообщение об успешной авторизации
 ├─ admin.html -> cgi-bin/admin_panel.sh
 └─ cgi-bin/
     ├─ admin_panel.sh    # вывод панели управления
     ├─ wifi_auth.sh      # проверка кода, выдача доступа
     ├─ update_code.sh    # изменение кода и длительности
     ├─ clear_sessions.sh # очистка активных сессий
     ├─ restart_portal.sh # перезапуск NoDogSplash
     └─ session_check.sh  # крон-скрипт, удаляющий просроченные сессии
/etc/config/wifi_auth     # настройки (код, длительность, дата обновления)
/tmp/active_sessions.txt  # база текущих сессий (MAC|IP|expiry_epoch)
```

## Сетевые параметры по умолчанию
- IP-адрес роутера: `192.168.9.1`
- Основной бридж: `br-lan`
- Wi-Fi-точка подключена к сети `lan`
- NoDogSplash обрабатывает подключения на интерфейсе `br-lan`

## Установка на OpenWrt 24.10.0

### Быстрая установка из GitHub
На устройстве с доступом в интернет достаточно одной команды:

```sh
wget -qO- https://raw.githubusercontent.com/DoNBaLooN/pvzrouter/main/install.sh | sh
```

Можно использовать `curl` или `uclient-fetch` — достаточно вывести содержимое на стандартный ввод `sh`:

```sh
curl -fsSL https://raw.githubusercontent.com/DoNBaLooN/pvzrouter/main/install.sh | sh
uclient-fetch -q -O- https://raw.githubusercontent.com/DoNBaLooN/pvzrouter/main/install.sh | sh
```

Перед запуском допускается задать переменные окружения (например, `BRANCH`, `REPO_URL`, `WORKDIR`, `ARCHIVE_URL`).

### Установка из локального архива
1. Скопируйте архив репозитория (например, `pvzrouter.tar.gz`) в каталог `/root` на роутере.
2. Распакуйте архив и перейдите в директорию проекта:
   ```sh
   cd /root
   tar -xzf pvzrouter.tar.gz
   cd pvzrouter
   ```
   > Если внутри архива находится папка вроде `pvzrouter-main`, переименуйте её: `mv pvzrouter-main pvzrouter`.
3. Запустите установщик, используя локальные файлы:
   ```sh
   USE_LOCAL_SOURCE=1 sh install.sh
   ```
   При необходимости можно указать другой путь к распакованному каталогу:
   ```sh
   USE_LOCAL_SOURCE=1 SOURCE_DIR=/root/pvzrouter-backup sh install.sh
   ```
   Скрипт также поддерживает онлайн-установку (скачивание с GitHub) при запуске без `USE_LOCAL_SOURCE=1`.
4. Скрипт выполняет:
   - подготовку файлов проекта (из локального каталога или из GitHub);
   - копирование HTML/CGI-файлов в `/www`;
   - настройку `/etc/config/wifi_auth` через `uci` (с сохранением текущих значений, если они уже существуют);
   - создание файла `/tmp/active_sessions.txt` и установку прав;
   - добавление задания cron `*/5 * * * * /www/cgi-bin/session_check.sh`;
   - перезапуск `uhttpd` и `nodogsplash` (при наличии).

После установки портал доступен по адресу `http://192.168.9.1/`, а админ-панель — `http://192.168.9.1/admin.html`.

## Эксплуатация
- Смена кода и длительности выполняется только через веб-панель. Дата изменения сохраняется в конфиге `wifi_auth`.
- Активные сессии хранятся в `/tmp/active_sessions.txt` и очищаются автоматически по cron или вручную.
- При перезапуске роутера данные о сессиях очищаются, что соответствует требованиям безопасности.

## Безопасность
- Рекомендуется ограничить доступ к `/admin.html` только локальной сети и включить HTTP Basic Auth в `uhttpd`.
- Персональные данные не сохраняются: только MAC-адреса клиентов и время окончания сессии.

## Тесты и сценарии приёмки
- Ввод корректного кода даёт доступ на заданное время.
- Неверный код приводит к отказу.
- Изменение кода/длительности применяется немедленно.
- Очистка сессий мгновенно блокирует клиентов.
- Через установленный интервал cron-скрипт отзывает доступ у просроченных клиентов.
- Кнопка перезапуска NoDogSplash выполняет перезапуск службы.

## Лицензия
Проект распространяется под лицензией MIT.
